<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒã‚¤ã‚­ãƒ£ãƒ©ä¸€è¦§ | Daily Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 min-h-screen flex items-center justify-center">

  <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-4xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">ãƒã‚¤ã‚­ãƒ£ãƒ©ä¸€è¦§</h1>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ & ã‚½ãƒ¼ãƒˆ -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-3">
      <div>
        <label class="mr-2 font-semibold">ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ•ã‚£ãƒ«ã‚¿:</label>
        <select id="filter" class="border rounded-lg px-3 py-1">
          <option value="all">ã™ã¹ã¦</option>
          <option value="common">ãƒãƒ¼ãƒãƒ«</option>
          <option value="rare">ãƒ¬ã‚¢</option>
          <option value="super-rare">ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¬ã‚¢</option>
          <option value="ultra-rare">ã‚¦ãƒ«ãƒˆãƒ©ãƒ¬ã‚¢</option>
        </select>
      </div>
      <div>
        <label class="mr-2 font-semibold">ã‚½ãƒ¼ãƒˆ:</label>
        <select id="sort" class="border rounded-lg px-3 py-1">
          <option value="newest">æ–°ã—ã„é †</option>
          <option value="oldest">å¤ã„é †</option>
          <option value="rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †</option>
          <option value="name">åå‰é †</option>
        </select>
      </div>
    </div>

    <!-- ã‚­ãƒ£ãƒ©ãƒªã‚¹ãƒˆ -->
    <div id="char-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>

    <!-- æˆ»ã‚‹ -->
    <div class="text-center mt-6">
      <a href="./home.html" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ğŸ”‘ Firebaseè¨­å®š
    const firebaseConfig = {
apiKey: "AIzaSyDKjyxK2RixQKkpNp3kZkijDPGi39aNceE",
  authDomain: "daily-feed-414b6.firebaseapp.com",
  databaseURL: "https://daily-feed-414b6-default-rtdb.firebaseio.com",
  projectId: "daily-feed-414b6",
  storageBucket: "daily-feed-414b6.firebasestorage.app",
  messagingSenderId: "360432327059",
  appId: "1:360432327059:web:0cb52176305190294d3066",
  measurementId: "G-0R08TWS1WP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const rarityColors = {
      "common": "bg-gray-400 text-white",
      "rare": "bg-blue-500 text-white",
      "super-rare": "bg-yellow-400 text-black",
      "ultra-rare": "bg-purple-600 text-white"
    };

    let allCharacters = []; // Firestoreã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿
    let aggregated = [];    // é›†è¨ˆå¾Œãƒ‡ãƒ¼ã‚¿

    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";
      await loadCharacters(user.uid);

      // ãƒ•ã‚£ãƒ«ã‚¿ã¨ã‚½ãƒ¼ãƒˆã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById("filter").addEventListener("change", renderCharacters);
      document.getElementById("sort").addEventListener("change", renderCharacters);
    });

    // Firestoreã‹ã‚‰ã‚­ãƒ£ãƒ©èª­ã¿è¾¼ã¿
    async function loadCharacters(uid) {
      const snap = await getDocs(collection(db, "users", uid, "characters"));
      allCharacters = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      aggregateCharacters();
      renderCharacters();
    }

    // ã‚­ãƒ£ãƒ©ã‚’é›†è¨ˆï¼ˆæ‰€æŒæ•°ã‚«ã‚¦ãƒ³ãƒˆï¼‰
    function aggregateCharacters() {
      const map = {};
      allCharacters.forEach(c => {
        if (!map[c.name]) {
          map[c.name] = { ...c, count: 0 };
        }
        map[c.name].count++;
      });
      aggregated = Object.values(map);
    }

    // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®é †åº
    const rarityOrder = { "ultra-rare": 1, "super-rare": 2, "rare": 3, "common": 4 };

    // ã‚­ãƒ£ãƒ©æç”»
    function renderCharacters() {
      const filter = document.getElementById("filter").value;
      const sort = document.getElementById("sort").value;
      const charList = document.getElementById("char-list");
      charList.innerHTML = "";

      let chars = [...aggregated];

      // ãƒ•ã‚£ãƒ«ã‚¿
      if (filter !== "all") {
        chars = chars.filter(c => c.rarity === filter);
      }

      // ã‚½ãƒ¼ãƒˆ
      if (sort === "rarity") {
        chars.sort((a, b) => rarityOrder[a.rarity] - rarityOrder[b.rarity]);
      } else if (sort === "name") {
        chars.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sort === "oldest") {
        chars.sort((a, b) => (a.obtainedAt?.seconds || 0) - (b.obtainedAt?.seconds || 0));
      } else {
        // newest
        chars.sort((a, b) => (b.obtainedAt?.seconds || 0) - (a.obtainedAt?.seconds || 0));
      }

      if (chars.length === 0) {
        charList.innerHTML = "<p class='text-center text-gray-500 col-span-3'>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ã‚­ãƒ£ãƒ©ãŒã„ã¾ã›ã‚“ã€‚</p>";
        return;
      }

      // ã‚«ãƒ¼ãƒ‰UIç”Ÿæˆ
      chars.forEach(c => {
        const rarityClass = rarityColors[c.rarity] || "bg-gray-300 text-black";
        const obtained = c.obtainedAt?.toDate ? c.obtainedAt.toDate().toLocaleString() : "ä¸æ˜";

        charList.innerHTML += `
          <div class="border rounded-xl p-4 shadow hover:shadow-lg transition bg-white flex flex-col items-center">
            <img src="${c.image}" alt="${c.name}" class="w-24 h-24 mx-auto rounded-lg mb-3">
            <h3 class="text-lg font-semibold text-gray-700">${c.name} Ã—${c.count}</h3>
            <span class="inline-block mt-1 px-3 py-1 rounded-full text-sm ${rarityClass}">
              ${c.rarity}
            </span>
            <p class="text-xs text-gray-500 mt-2">æœ€åˆã®å…¥æ‰‹: ${obtained}</p>
            <a href="battle.html?char=${encodeURIComponent(c.name)}" 
               class="mt-3 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm">
               ã“ã®ã‚­ãƒ£ãƒ©ã§ãƒãƒˆãƒ«
            </a>
          </div>
        `;
      });
    }
  </script>
</body>
</html>
