<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ログインページ</title>
</head>
<body>
  <h2>ログイン / 新規登録</h2>
  <input id="email" type="email" placeholder="メールアドレス"><br>
  <input id="password" type="password" placeholder="パスワード"><br>
  <button onclick="handleRegister(this)">新規登録</button>
  <button onclick="handleLogin(this)">ログイン</button>
  <hr>
  <button onclick="handleGoogleLogin(this)">Googleでログイン</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // あなたのFirebase設定に置き換え
    const firebaseConfig = {
apiKey: "AIzaSyDKjyxK2RixQKkpNp3kZkijDPGi39aNceE",
  authDomain: "daily-feed-414b6.firebaseapp.com",
  databaseURL: "https://daily-feed-414b6-default-rtdb.firebaseio.com",
  projectId: "daily-feed-414b6",
  storageBucket: "daily-feed-414b6.firebasestorage.app",
  messagingSenderId: "360432327059",
  appId: "1:360432327059:web:0cb52176305190294d3066",
  measurementId: "G-0R08TWS1WP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // すでにログイン中ならホームへ
    onAuthStateChanged(auth, (user) => {
      if (user) location.href = "home.html";
    });

    // 🔹 新規登録（登録済みならログインに切り替え）
    window.handleRegister = async (btn) => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      btn.disabled = true; btn.textContent = "処理中...";
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);

        // Firestoreにプロフィール保存（初回のみ）
        await setDoc(doc(db, "users", userCred.user.uid), {
          uid: userCred.user.uid,
          name: email.split("@")[0],
          email: email,
          photoURL: "",
          createdAt: new Date(),
        }, { merge: true });

        location.href = "home.html";

      } catch (err) {
        if (err.code === "auth/email-already-in-use") {
          // 既に登録済みならログイン
          try {
            const userCred = await signInWithEmailAndPassword(auth, email, pass);
            location.href = "home.html";
          } catch (loginErr) {
            alert("ログイン失敗: " + loginErr.message);
          }
        } else {
          alert("登録失敗: " + err.message);
        }
      } finally {
        btn.disabled = false; btn.textContent = "新規登録";
      }
    };

    // 🔹 通常ログイン
    window.handleLogin = async (btn) => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      btn.disabled = true; btn.textContent = "ログイン中...";
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        location.href = "home.html";
      } catch (err) {
        alert("ログイン失敗: " + err.message);
      } finally {
        btn.disabled = false; btn.textContent = "ログイン";
      }
    };

    // 🔹 Googleログイン
    window.handleGoogleLogin = async (btn) => {
      btn.disabled = true; btn.textContent = "Googleログイン中...";
      try {
        const provider = new GoogleAuthProvider();
        const userCred = await signInWithPopup(auth, provider);

        // Firestoreにプロフィール保存（初回のみ）
        await setDoc(doc(db, "users", userCred.user.uid), {
          uid: userCred.user.uid,
          name: userCred.user.displayName || "NoName",
          email: userCred.user.email,
          photoURL: userCred.user.photoURL || "",
          createdAt: new Date(),
        }, { merge: true });

        location.href = "home.html";
      } catch (err) {
        alert("Googleログイン失敗: " + err.message);
      } finally {
        btn.disabled = false; btn.textContent = "Googleでログイン";
      }
    };
  </script>
</body>
</html>
