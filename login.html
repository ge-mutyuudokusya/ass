<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</title>
</head>
<body>
  <h2>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button onclick="handleRegister(this)">æ–°è¦ç™»éŒ²</button>
  <button onclick="handleLogin(this)">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <hr>
  <button onclick="handleGoogleLogin(this)">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ã‚ãªãŸã®Firebaseè¨­å®šã«ç½®ãæ›ãˆ
    const firebaseConfig = {
apiKey: "AIzaSyDKjyxK2RixQKkpNp3kZkijDPGi39aNceE",
  authDomain: "daily-feed-414b6.firebaseapp.com",
  databaseURL: "https://daily-feed-414b6-default-rtdb.firebaseio.com",
  projectId: "daily-feed-414b6",
  storageBucket: "daily-feed-414b6.firebasestorage.app",
  messagingSenderId: "360432327059",
  appId: "1:360432327059:web:0cb52176305190294d3066",
  measurementId: "G-0R08TWS1WP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ãƒ›ãƒ¼ãƒ ã¸
    onAuthStateChanged(auth, (user) => {
      if (user) location.href = "home.html";
    });

    // ğŸ”¹ æ–°è¦ç™»éŒ²ï¼ˆç™»éŒ²æ¸ˆã¿ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
    window.handleRegister = async (btn) => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      btn.disabled = true; btn.textContent = "å‡¦ç†ä¸­...";
      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);

        // Firestoreã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ï¼ˆåˆå›ã®ã¿ï¼‰
        await setDoc(doc(db, "users", userCred.user.uid), {
          uid: userCred.user.uid,
          name: email.split("@")[0],
          email: email,
          photoURL: "",
          createdAt: new Date(),
        }, { merge: true });

        location.href = "home.html";

      } catch (err) {
        if (err.code === "auth/email-already-in-use") {
          // æ—¢ã«ç™»éŒ²æ¸ˆã¿ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³
          try {
            const userCred = await signInWithEmailAndPassword(auth, email, pass);
            location.href = "home.html";
          } catch (loginErr) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + loginErr.message);
          }
        } else {
          alert("ç™»éŒ²å¤±æ•—: " + err.message);
        }
      } finally {
        btn.disabled = false; btn.textContent = "æ–°è¦ç™»éŒ²";
      }
    };

    // ğŸ”¹ é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³
    window.handleLogin = async (btn) => {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      btn.disabled = true; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        location.href = "home.html";
      } catch (err) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + err.message);
      } finally {
        btn.disabled = false; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
      }
    };

    // ğŸ”¹ Googleãƒ­ã‚°ã‚¤ãƒ³
    window.handleGoogleLogin = async (btn) => {
      btn.disabled = true; btn.textContent = "Googleãƒ­ã‚°ã‚¤ãƒ³ä¸­...";
      try {
        const provider = new GoogleAuthProvider();
        const userCred = await signInWithPopup(auth, provider);

        // Firestoreã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ï¼ˆåˆå›ã®ã¿ï¼‰
        await setDoc(doc(db, "users", userCred.user.uid), {
          uid: userCred.user.uid,
          name: userCred.user.displayName || "NoName",
          email: userCred.user.email,
          photoURL: userCred.user.photoURL || "",
          createdAt: new Date(),
        }, { merge: true });

        location.href = "home.html";
      } catch (err) {
        alert("Googleãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + err.message);
      } finally {
        btn.disabled = false; btn.textContent = "Googleã§ãƒ­ã‚°ã‚¤ãƒ³";
      }
    };
  </script>
</body>
</html>
