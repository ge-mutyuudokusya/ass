<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // Firebase 設定
  const firebaseConfig = {
 apiKey: "AIzaSyDKjyxK2RixQKkpNp3kZkijDPGi39aNceE",
  authDomain: "daily-feed-414b6.firebaseapp.com",
  databaseURL: "https://daily-feed-414b6-default-rtdb.firebaseio.com",
  projectId: "daily-feed-414b6",
  storageBucket: "daily-feed-414b6.firebasestorage.app",
  messagingSenderId: "360432327059",
  appId: "1:360432327059:web:0cb52176305190294d3066",
  measurementId: "G-0R08TWS1WP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let todayPulls = 0;
  const maxPullsPerDay = 5;
  const today = new Date().toLocaleDateString();

  const rarityLabel = { "common": "ノーマル", "rare": "レア", "super-rare": "スーパーレア", "ultra-rare": "ウルトラレア" };
  const rarityChances = { "common": 50, "rare": 30, "super-rare": 15, "ultra-rare": 5 };
  const items = [
    { id: 1, name: "グラサン", image: "as.png", rarity: "common" },
    { id: 2, name: "コーヒー", image: "cup-caffee.png", rarity: "common" },
    { id: 3, name: "ドラム缶", image: "trsf.png", rarity: "rare" },
    { id: 4, name: "髭", image: "984552 (1).png", rarity: "rare" },
    { id: 5, name: "サイト", image: "サイト.png", rarity: "super-rare" },
    { id: 6, name: "ちくわ", image: "ちくわ.png", rarity: "super-rare" },
    { id: 7, name: "鳥つくね", image: "鶏つくね.png", rarity: "ultra-rare" }
  ];

  // ログイン確認
  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "login.html";
    currentUser = user;
    await loadZukan();
    await countTodayPulls();
  });

  function getRandomRarity() {
    const rand = Math.random() * 100;
    let total = 0;
    for (const [rarity, chance] of Object.entries(rarityChances)) {
      total += chance;
      if (rand < total) return rarity;
    }
    return "common";
  }

  // ガチャ処理
  window.rollGacha = async () => {
    if (!currentUser) return alert("ログインしてください");
    if (todayPulls >= maxPullsPerDay) {
      document.getElementById("limitMessage").innerText = `本日は${maxPullsPerDay}回までです！`;
      return;
    }

    document.getElementById("limitMessage").innerText = "";
    document.getElementById("gachaSound").play();

    const rarity = getRandomRarity();
    const pool = items.filter(item => item.rarity === rarity);
    const item = pool[Math.floor(Math.random() * pool.length)];

    try {
      await addDoc(collection(db, "users", currentUser.uid, "characters"), {
        name: item.name,
        image: item.image,
        rarity: item.rarity,
        obtainedAt: serverTimestamp(),
        day: today
      });

      todayPulls++;
      showResult(item);
      await loadZukan();
    } catch (err) {
      alert("保存エラー: " + err.message);
    }
  };

  function showResult(item) {
    const resultDiv = document.getElementById("result");
    const specialEffect = item.rarity === "ultra-rare" ? '<div class="special-effect">✨確定演出!!✨</div>' : "";
    resultDiv.innerHTML = `
      ${specialEffect}
      <div class="fade-in">
        <img src="${item.image}" class="item-image">
        <div class="item-name">${item.name}</div>
        <div class="rarity ${item.rarity}">${rarityLabel[item.rarity]}</div>
      </div>
    `;
  }

  async function loadZukan() {
    const snap = await getDocs(collection(db, "users", currentUser.uid, "characters"));
    const zukan = document.getElementById("zukan");
    zukan.innerHTML = "";

    const owned = {};
    snap.forEach(doc => {
      const data = doc.data();
      owned[data.name] = (owned[data.name] || 0) + 1;
    });

    items.forEach(item => {
      const count = owned[item.name] || 0;
      const imgClass = count > 0 ? "" : "unknown";
      const imgSrc = count > 0 ? item.image : "https://cdn.pixabay.com/photo/2016/08/20/05/39/question-mark-1600718_1280.png";
      const name = count > 0 ? `${item.name} × ${count}` : "？？？";

      zukan.innerHTML += `
        <div class="zukan-item">
          <img src="${imgSrc}" class="${imgClass}">
          <div>${name}</div>
        </div>
      `;
    });
  }

  async function countTodayPulls() {
    const snap = await getDocs(query(
      collection(db, "users", currentUser.uid, "characters"),
      where("day", "==", today)
    ));
    todayPulls = snap.size;
  }
</script>
