<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ガチャ | Daily Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-yellow-100 via-pink-100 to-purple-100 min-h-screen flex items-center justify-center">

  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
    <h1 class="text-2xl font-bold mb-6 text-gray-800">ガチャ</h1>

    <!-- ガチャ結果 -->
    <div id="result-box" class="hidden mb-6">
      <img id="char-img" src="" alt="キャラ画像" class="w-32 h-32 mx-auto mb-3 rounded-full shadow">
      <p id="char-name" class="text-xl font-semibold text-gray-700"></p>
    </div>

    <!-- ボタン -->
    <button onclick="doGacha(this)" 
      class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 rounded-lg transition mb-4">
      ガチャを引く
    </button>
    <a href="./home.html" 
      class="block w-full bg-gray-400 hover:bg-gray-500 text-white py-2 rounded-lg transition">
      マイページへ戻る
    </a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyDKjyxK2RixQKkpNp3kZkijDPGi39aNceE",
  authDomain: "daily-feed-414b6.firebaseapp.com",
  databaseURL: "https://daily-feed-414b6-default-rtdb.firebaseio.com",
  projectId: "daily-feed-414b6",
  storageBucket: "daily-feed-414b6.firebasestorage.app",
  messagingSenderId: "360432327059",
  appId: "1:360432327059:web:0cb52176305190294d3066",
  measurementId: "G-0R08TWS1WP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // ログインしてなければリダイレクト
    onAuthStateChanged(auth, (user) => {
      if (!user) location.href = "login.html";
      else currentUser = user;
    });

    // ガチャ候補キャラ
    const characters = [
      { name: "勇者アレックス", img: "https://via.placeholder.com/150/FF0000/FFFFFF?text=Alex" },
      { name: "魔法使いミラ", img: "https://via.placeholder.com/150/800080/FFFFFF?text=Mira" },
      { name: "剣士カイル", img: "https://via.placeholder.com/150/0000FF/FFFFFF?text=Kyle" },
      { name: "僧侶サラ", img: "https://via.placeholder.com/150/008000/FFFFFF?text=Sara" },
      { name: "ドラゴン", img: "https://via.placeholder.com/150/FFA500/FFFFFF?text=Dragon" }
    ];

    // ガチャ実行
    window.doGacha = async (btn) => {
      if (!currentUser) return alert("ログインしてください");
      btn.disabled = true; btn.textContent = "抽選中...";

      try {
        // ランダム抽選
        const char = characters[Math.floor(Math.random() * characters.length)];

        // Firestoreに保存
        await addDoc(collection(db, "users", currentUser.uid, "characters"), {
          name: char.name,
          img: char.img,
          obtainedAt: serverTimestamp()
        });

        // 画面に表示
        document.getElementById("char-name").textContent = char.name;
        document.getElementById("char-img").src = char.img;
        document.getElementById("result-box").classList.remove("hidden");
      } catch (err) {
        alert("ガチャ失敗: " + err.message);
      }

      btn.disabled = false; btn.textContent = "ガチャを引く";
    };
  </script>
</body>
</html>
